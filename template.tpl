___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Criteo Dynamic Loader - ecommerce auto tagging",
  "categories": ["ADVERTISING", "CONVERSIONS", "REMARKETING"],
  "brand": {
    "id": "criteo_logo_2021",
    "displayName": "Criteo",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "This tag template enables you to fire all required Criteo events and event parameters based on your GA4 enhanced ecommerce site tagging.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "criteo_account_id",
    "displayName": "Criteo Account ID",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "clearOnCopy": true,
    "notSetText": "Account ID has to be set in order for tracking to work"
  },
  {
    "type": "RADIO",
    "name": "criteo_site_type_source",
    "displayName": "Site type",
    "radioItems": [
      {
        "value": "auto-detect",
        "displayValue": "Auto detect",
        "subParams": [
          {
            "type": "TEXT",
            "name": "criteo_user_agent",
            "displayName": "User Agent String",
            "simpleValueType": true,
            "alwaysInSummary": true,
            "textAsList": true,
            "help": "Enter a valid user agent manually or create a Custom JavaScript variable to read the \u0027navigator.userAgent\u0027 variable"
          }
        ]
      },
      {
        "value": "manual",
        "displayValue": "Manual",
        "subParams": [
          {
            "type": "SELECT",
            "name": "criteo_site_type_source_manual",
            "displayName": "",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "d",
                "displayValue": "Desktop"
              },
              {
                "value": "m",
                "displayValue": "Mobile"
              },
              {
                "value": "t",
                "displayValue": "Tablet"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "d",
            "alwaysInSummary": true
          }
        ],
        "help": ""
      }
    ],
    "simpleValueType": true,
    "defaultValue": "auto-detect"
  },
  {
    "type": "TEXT",
    "name": "criteo_hashed_email",
    "displayName": "Hashed Email",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "criteo_zipcode",
    "displayName": "Zip code",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "alwaysInSummary": true
  },
  {
    "type": "LABEL",
    "name": "criteo_event_autodetect_info",
    "displayName": "Attach one or more triggers to this tag that covers all ecommerce actions needed by Criteo: Homepage view, Product list view, Product detail view, Add to cart, Cart page view, Order confirmation page view.\u003cbr/\u003e\n\u003cbr/\u003e\nYou can also fire this tag on all pages in order to send Criteo data about your landing page bounce rates.\u003cbr/\u003e\n\u003cbr/\u003e\nIf you are using different event names as in the list of \u003ca href\u003d\"https://developers.google.com/tag-manager/ecommerce-ga4\"\u003estandard GA4 ecommerce events\u003c/a\u003e, you can enter your GTM event names bellow to adjust tag behavior."
  },
  {
    "type": "GROUP",
    "name": "criteo_event_overrides",
    "displayName": "Override default event names and page path",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "criteo_override_homepage_url",
        "displayName": "Homepage Path (default: /)",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "alwaysInSummary": false
      },
      {
        "type": "TEXT",
        "name": "criteo_override_view_item_list",
        "displayName": "View item list event (default: view_item_list)",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "alwaysInSummary": false
      },
      {
        "type": "TEXT",
        "name": "criteo_override_view_item",
        "displayName": "View item/product event (default: view_item)",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "alwaysInSummary": false
      },
      {
        "type": "TEXT",
        "name": "criteo_override_add_to_cart",
        "displayName": "Add to cart event (default: add_to_cart)",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "alwaysInSummary": false
      },
      {
        "type": "TEXT",
        "name": "criteo_override_view_cart",
        "displayName": "View cart page event (default: view_cart)",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "alwaysInSummary": false
      },
      {
        "type": "TEXT",
        "name": "criteo_override_purchase",
        "displayName": "Purchase (sales confirmation) event (default: purchase)",
        "simpleValueType": true,
        "canBeEmptyString": false,
        "alwaysInSummary": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const createQueue = require('createQueue');
// const copyFromWindow = require('copyFromWindow');
const getUrl = require('getUrl');
const copyFromDataLayer = require('copyFromDataLayer');

const tms_id = "gtm-jabjab-ga4-1.0.0";

const account_id = data.criteo_account_id || '';
if (account_id.length == 0) {
  log("[Criteo Dynamic Loader] Account ID not set, aborting!");
  data.gtmOnFailure();
} else {
  /* Create command array and push account ID */
  let criteo_command_q = [];
  criteo_command_q.push({ event: "setAccount", account: account_id });
  
  /* Set site type */
  const site_type_source = data.criteo_site_type_source || 'auto-detect';
  let site_type_source_manual = data.criteo_site_type_source || 'd';
  
  if ("auto-detect" == site_type_source) {
    site_type_source_manual = "d";
    
    const user_agent = data.criteo_user_agent;
    
    if (user_agent.indexOf('iPad') > -1 ) {
      site_type_source_manual = "t";
    } else if (user_agent.indexOf('Mobile') > -1 ) {
      site_type_source_manual = "m";
    } else if (user_agent.indexOf('iPhone') > -1 ) {
      site_type_source_manual = "m";
    } else if (user_agent.indexOf('iPod') > -1 ) {
      site_type_source_manual = "m";
    } else if (user_agent.indexOf('Android') > -1 ) {
      site_type_source_manual = "m";
    } else if (user_agent.indexOf('BlackBerry') > -1 ) {
      site_type_source_manual = "m";
    } else if (user_agent.indexOf('IEMobile') > -1 ) {
      site_type_source_manual = "m";
    } else if (user_agent.indexOf('Silk') > -1 ) {
      site_type_source_manual = "m";
    } else {
      site_type_source_manual = "d";
    }
  }
  criteo_command_q.push({ event: "setSiteType", type: site_type_source_manual});

  /* Add hashed email if set */
  const hashed_email = data.criteo_hashed_email || '';
  if ( "" != hashed_email ) {
    if ( hashed_email.indexOf('@') > -1 ) {
      log("[Criteo Dynamic Loader] Email parameter does not seem to be hashed, ommited!");
    } else {
      criteo_command_q.push({ event: "setEmail", email: hashed_email });
    }
  }
 
  /* Add zipcode if set */
  const zipcode = data.criteo_zipcode || '';
  if ( "" != zipcode ) {
    criteo_command_q.push({ event: "setZipcode", zipcode: zipcode });
  }

  /* Detect ecommerce action */
  const homepage_url = data.criteo_override_homepage_url || '/';
  const event_view_item_list = data.criteo_override_view_item_list || 'view_item_list';
  const event_view_item = data.criteo_override_view_item || 'view_item';
  const event_add_to_cart = data.criteo_override_add_to_cart || 'add_to_cart';
  const event_view_cart = data.criteo_override_view_cart || 'view_cart';
  const event_purchase = data.criteo_override_purchase || 'purchase';
  
  const last_event = copyFromDataLayer('event'); // get the last pushed event name
  const ecommerce  = copyFromDataLayer('ecommerce', 1); // do not merge recursively with past ecommerce events
    
  if ( event_view_item_list == last_event ) {
    let items = [];
    if ( ecommerce && ecommerce.items ) {
      for(let i=0; i<3; i++) {
        items.push(ecommerce.items[i].item_id);
      }
    }

    criteo_command_q.push({
      event: "viewList",
      tms: tms_id,
      currency: ecommerce.currency,
      item: items
    });
  } else if ( event_view_item == last_event ) {
    criteo_command_q.push({
      event: "viewItem",
      tms: tms_id,
      currency: ecommerce.currency,
      item: ecommerce && ecommerce.items && ecommerce.items[0].item_id
    });

  } else if ( event_add_to_cart == last_event ) {
    let items = [];
    if ( ecommerce && ecommerce.items ) {
      ecommerce.items.forEach(function(product) {
        items.push({
          id: product.item_id,
          price: product.item_price,
          quantity: product.quantity
        });
      });
    }

    criteo_command_q.push({
      event: "addToCart",
      tms: tms_id,
      currency: ecommerce.currency,
      item: items
    });

  } else if ( event_view_cart == last_event ) {
    let items = [];
    if ( ecommerce && ecommerce.items ) {
      ecommerce.items.forEach(function(product) {
        items.push({
          id: product.item_id,
          price: product.item_price,
          quantity: product.quantity
        });
      });
    }

    criteo_command_q.push({
      event: "viewBasket",
      tms: tms_id,
      currency: ecommerce.currency,
      item: items
    });

  } else if ( event_purchase == last_event ) {
    let items = [];
    if ( ecommerce && ecommerce.items ) {
      ecommerce.items.forEach(function(product) {
        items.push({
          id: product.item_id,
          price: product.item_price,
          quantity: product.quantity
        });
      });
    }

    criteo_command_q.push({
      event: "trackTransaction",
      tms: tms_id,
      currency: ecommerce.currency,
      id: ecommerce.transaction_id,
      item: items
    });
  } else {
    const current_page_path = getUrl('path');
    if ( current_page_path == homepage_url ) {
      criteo_command_q.push({
        event: "viewHome",
        tms: tms_id
      });
    } else {
      criteo_command_q.push({
        event: "viewPage",
        tms: tms_id
      });
    }
  }
  
  /* Set Criteo variable */
  const criteo_q_push = createQueue('criteo_q');
  log("[Criteo Dynamic Loader] Commands to send: ", criteo_command_q);
  criteo_q_push( criteo_command_q );

  injectScript("https://dynamic.criteo.com/js/ld/ld.js?a=" + account_id, data.gtmOnSuccess, data.gtmOnFailure, "criteo-onetag-dynamic");
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://dynamic.criteo.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "criteo_q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "path",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "event"
              },
              {
                "type": 1,
                "string": "ecommerce"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 7/19/2021, 11:53:14 AM


